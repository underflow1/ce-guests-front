# Промпт для добавления роута перемещения записи (drag&drop)

## Общая информация

Необходимо добавить отдельный роут для атомарного изменения времени/даты записи через drag&drop. Это позволит четко разделить операции редактирования записи и перемещения записи.

## Требования

### 1. Новый роут

**Роут:** PATCH `/entries/{id}/move`

**Метод:** PATCH

**Описание:** Атомарное изменение даты/времени записи (для drag&drop)

**Тело запроса:**
```json
{
  "datetime": "2026-01-30T14:00:00"
}
```

**Ответ:** Обновленная запись (та же структура, что возвращает GET `/entries/{id}`)

**WebSocket событие:** `entry_moved`

### 2. Логика работы

1. Принимает только поле `datetime` в теле запроса
2. Обновляет только поле `datetime` у записи (не трогает другие поля)
3. После успешного обновления отправляет WebSocket событие `entry_moved` со структурой:
   ```json
   {
     "type": "entry_moved",
     "data": {
       "entries": [...],  // Все записи недели (как в GET /entries)
       "reference_dates": {...},
       "calendar_structure": [...]
     },
     "change": {
       "entry": {
         "id": "uuid",
         "name": "Имя",
         "responsible": "Ответственный",
         "datetime": "2026-01-30T14:00:00",
         "is_completed": false
       }
     }
   }
   ```

### 3. Валидация

- Проверка существования записи с указанным `id`
- Проверка формата `datetime` (должен быть валидной датой/временем)
- Проверка прав доступа (пользователь должен иметь право на перемещение записей)

### 4. Обработка ошибок

- 404 - запись не найдена
- 400 - невалидный формат `datetime`
- 403 - нет прав на перемещение записей
- 422 - ошибка валидации

### 5. Отличие от PUT `/entries/{id}`

| Параметр | PUT `/entries/{id}` | PATCH `/entries/{id}/move` |
|----------|---------------------|----------------------------|
| Назначение | Редактирование записи (name, responsible) | Перемещение записи (datetime) |
| Поля | name, responsible, datetime, is_completed | Только datetime |
| WebSocket событие | `entry_updated` | `entry_moved` |
| Использование | Форма редактирования | Drag&drop |

**Важно:** 
- PUT `/entries/{id}` теперь НЕ должен обрабатывать изменение `datetime` - для этого используется PATCH `/entries/{id}/move`
- PUT `/entries/{id}` отправляет `entry_updated` только когда изменяются `name` или `responsible` (НЕ `datetime`)

### 6. Пример использования

**Запрос:**
```
PATCH /api/v1/entries/2a9a1884-0605-4757-ac65-a9ab8f998636/move
Content-Type: application/json

{
  "datetime": "2026-01-30T14:00:00"
}
```

**Ответ:**
```json
{
  "id": "2a9a1884-0605-4757-ac65-a9ab8f998636",
  "name": "Иван Иванов",
  "responsible": "Петр Петров",
  "datetime": "2026-01-30T14:00:00",
  "is_completed": false
}
```

**WebSocket событие (отправляется всем подключенным клиентам):**
```json
{
  "type": "entry_moved",
  "data": {
    "entries": [...],
    "reference_dates": {...},
    "calendar_structure": [...]
  },
  "change": {
    "entry": {
      "id": "2a9a1884-0605-4757-ac65-a9ab8f998636",
      "name": "Иван Иванов",
      "responsible": "Петр Петров",
      "datetime": "2026-01-30T14:00:00",
      "is_completed": false
    }
  }
}
```

## Чеклист реализации

- [ ] Создать роут PATCH `/entries/{id}/move`
- [ ] Добавить валидацию `datetime`
- [ ] Реализовать обновление только поля `datetime`
- [ ] Отправлять WebSocket событие `entry_moved` после успешного обновления
- [ ] Обновить PUT `/entries/{id}` чтобы он НЕ обрабатывал изменение `datetime`
- [ ] Обновить логику PUT `/entries/{id}` чтобы отправлять `entry_updated` только при изменении `name` или `responsible`
- [ ] Добавить проверку прав доступа
- [ ] Протестировать роут
